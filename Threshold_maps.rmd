---
title: "OSPAR Assessment Steps for UK ESG"
author: "Kate Collingridge and Liam Fernand"
date: "22/02/2022"
output: html_document
---

```{r setup, include=FALSE}
library(leaflet)
library(sf)
library(viridis)
library(leafsync)
library(rgdal)
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

This document presents the new proposed eutrophication assessment thresholds for UK assessment areas for consideration by the Eutrophication Steering Group. For more detail on how the threshold and assessment areas were developed see the ICG-EMO report and OSPAR COMP Annexes (3 and 7)

## Previous thresholds

For the previous comprehensive eutrophication assessment thresholds were the same for all assessment areas and only dependent on salinity with a different threshold for "coastal" and "offshore" waters.


```{r old thresholds}
#Map of old assessment thresholds.
COMP3_areas <- readOGR(dsn = "C:/Users/KC05/OneDrive - CEFAS/Shiny_apps/COMP_data/COMP_data_shiny/data", layer = "CP2_WGS84", verbose = T)

leaflet(COMP3_areas) %>%
  addTiles() %>%
  addPolygons(color = "black", fillOpacity = 0, weight = 1, label = COMP3_areas$CP2_Region) %>% # popups not quite working properly
  setView(-0,55,zoom = 5)
#DIN. toggle for coastal/offshore
#Chl
#Doxy

```

## Eunosat

During the eunosat project a different approach for determining thresholds was developed. "Reference conditions" for nutrients and chlorophyll were modelled for the year 1900 and 50% was added to these to form the assessment thresholds. This was based on xxx model at Deltares.

### Assessment areas

At the same time new "ecologically coherent" assessment areas were developed (more detail, or just ref eunosat report). These have been further modified to incorporate river plumes (e.g. Thames, Humber and Liverpool Bay) and additional assessment areas in places not covered during the EUNOSAT project.
Assessment thresholds were averaged for each assessment area.

```{r assessment areas}
COMP4_areas <- sf::st_read("https://raw.githubusercontent.com/ices-tools-dev/COMPEAT/master/assessment_areas/COMP4_assessment_areas.csv",quiet = T) %>%
  st_set_crs(4326)
#Map of new assessment areas
leaflet(COMP4_areas) %>%
  addTiles() %>%
  addPolygons(color = "black", fillOpacity = 0, weight = 1, label = ~COMP4_areas$ID, popup = COMP4_areas$Area_Name_) %>% # popups not quite working properly
  setView(-0,55,zoom = 5)

```

## ICG-EMO

The work on thresholds has been further developed by ICG-EMO, using x models.... Liam to expand.

HS1 and HS2 scenarios

```{r new thresholds}
#Thresholds

thres <- read.table("C:/Users/KC05/OneDrive - CEFAS/Shiny_apps/COMP_data/COMP_data_shiny/data/Thresholds_ICGEMO_Jan2022.csv", header = T, sep = ",")

#merge thresholds onto COMP4_areas

COMP4_areas <- merge(COMP4_areas,thres,by="ID")
COMP4_areas <- sf:::as_Spatial(st_zm(COMP4_areas))

#Chl - might want to show 90th percentile too?

pal <- colorNumeric(palette = viridis(255), domain = c(0,20), na.color = "#00000000")
m1 <- leaflet(COMP4_areas) %>%
  addTiles() %>%
  addPolygons(fillColor = ~pal(Chla) ,color = "black", fillOpacity = 1, weight = 1, popup = paste0(COMP4_areas$Area_Name_, "<br>","Chlorophyll", " theshold: ", as.character(round(COMP4_areas$Chla,2)), " (HS1).")) %>%
  addLegend(pal = pal, values = c(0,20), title = "Chlorophyll (ug/l)") %>%
  setView(3,54, zoom = 4)

#DIN

pal <- colorNumeric(palette = viridis(255), domain = c(0,30), na.color = "#00000000")
m2 <- leaflet(COMP4_areas) %>%
  addTiles() %>%
  addPolygons(fillColor = ~pal(DIN) ,color = "black", fillOpacity = 1, weight = 1, popup = paste0(COMP4_areas$Area_Name_, "<br>","Chlorophyll", " theshold: ", as.character(round(COMP4_areas$DIN,2)), " (HS1)")) %>%
  addLegend(pal = pal, values = c(0,30), title = "DIN (uM)") %>%
  setView(3,54, zoom = 4)

#DIP

pal <- colorNumeric(palette = viridis(255), domain = c(0,3), na.color = "#00000000")
m3 <- leaflet(COMP4_areas) %>%
  addTiles() %>%
  addPolygons(fillColor = ~pal(DIP) ,color = "black", fillOpacity = 1, weight = 1, popup = paste0(COMP4_areas$Area_Name_, "<br>","Chlorophyll", " theshold: ", as.character(round(COMP4_areas$DIP,2)), " (HS1)")) %>%
  addLegend(pal = pal, values = c(0,3), title = "DIP (uM)") %>%
  setView(3,54, zoom = 4)
sync(m1, m2, m3, ncol = 3, sync.cursor = F)

#Doxy - Don't need map, it is 6 mg/l everywhere.

```

Any points of discussion.
Comparison of old and new thresholds

## WFD thresholds

Map of these? How does this affect them?